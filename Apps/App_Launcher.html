<!DOCTYPE html>
<!--
  File: micro-apps/app_launcher_remastered.html
  Purpose: A visually remastered app launcher that lets you load and switch between multiple
           standalone HTML files, styled to match the "Micro-App Template".

  Key Features:
    - Drag & drop or use the file chooser to load multiple .html files.
    - Sidebar lists all loaded apps for quick switching.
    - Renders the selected app in a sandboxed <iframe>.
    - Supports session export/import (saves file contents to a JSON).
    - Resizable sidebar and keyboard shortcuts for navigation.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>App Launcher (Remastered)</title>

  <style>
    /* ====== Design System (from App Template) ====== */
    :root {
      --bg: #0f1115;          /* main background (dark) */
      --panel: #151924;        /* panels/cards */
      --panel-2: #0c0f16;      /* deeper panels */
      --text: #e5e7eb;         /* primary text */
      --text-muted: #a3aab8;    /* secondary text */
      --primary: #5b9cff;      /* accent color */
      --primary-2: #2f6fe6;    /* accent hover */
      --border: #232836;        /* subtle borders */
      --success: #22c55e;
      --warning: #fbbf24;
      --danger:  #ef4444;
      --shadow:  rgba(0,0,0,0.4);
      --radius:  14px;          /* rounded corners standard */
      --radius-sm: 10px;        /* smaller radius */
      --pad: 14px;              /* standard spacing */
    }

    /* ====== Global Resets & Typography ====== */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* Prevent body scroll */
    }

    /* ====== App Shell Layout ====== */
    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100%;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: var(--pad);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0)) , var(--bg);
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .brand svg { color: var(--primary); }

    .topbar-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ====== Main Split Layout ====== */
    .main {
      display: flex;
      min-height: 0; /* Important for flexbox children to scroll */
    }

    .sidebar {
      width: 320px;
      min-width: 220px;
      max-width: 560px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: var(--pad);
      display: flex;
      flex-direction: column;
      gap: var(--pad);
      box-shadow: 0 10px 30px var(--shadow);
    }

    .content {
      flex: 1;
      min-width: 0; /* Prevents iframe from overflowing */
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .content-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--pad);
      border-bottom: 1px solid var(--border);
      background: var(--panel-2);
    }

    .content-body {
      padding: 0;
      overflow: hidden; /* Let the iframe handle its own scroll */
    }

    /* ====== UI Components ====== */
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .btn:hover { transform: translateY(-1px); border-color: var(--primary); }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
    .btn.primary:hover { background: var(--primary-2); border-color: var(--primary-2); }
    .btn.success { background: var(--success); border-color: var(--success); color: white; }
    .btn.success:hover { background: #16a34a; border-color: #16a34a; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    .btn.danger:hover { background: #dc2626; border-color: #dc2626; }

    .input {
        width: 100%;
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        font-size: 14px;
    }
    .input:focus { outline: none; border-color: var(--primary); }

    .dropzone {
        padding: var(--pad);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--border);
        background: var(--panel-2);
        text-align: center;
        transition: border-color 120ms ease, background-color 120ms ease;
    }
    .dropzone.active {
        border-color: var(--primary);
        background: rgba(91,156,255,0.1);
    }
    .dropzone p { margin: 0; }
    .dropzone .muted { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    .file-list {
        flex: 1;
        overflow-y: auto;
        margin: 0 -4px;
        padding: 0 4px;
        list-style: none;
        display: grid;
        gap: 8px;
        align-content: start;
    }

    .file-item button {
        width: 100%;
        text-align: left;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
        color: var(--text);
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .file-item button:hover {
        transform: translateY(-1px);
        border-color: var(--primary);
    }
    .file-item button.active {
        border-color: var(--primary);
        background: linear-gradient(180deg, rgba(91,156,255,0.18), rgba(91,156,255,0.04));
    }
    .file-item .name { flex: 1; min-width: 0; }
    .file-item .name .main-name { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-item .name .meta { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-item .actions { display: flex; gap: 6px; }
    .file-item .actions button {
        padding: 4px 8px;
        font-size: 11px;
        width: auto;
        background: var(--panel);
    }
    .file-item .actions button:hover {
        background: var(--panel-2);
    }

    /* ====== Utilities ====== */
    .hidden { display: none !important; }
    .spacer { flex: 1; }
    .muted { color: var(--text-muted); }
    .resizer {
        width: 6px;
        cursor: col-resize;
        background: var(--bg);
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        transition: background 120ms ease;
    }
    .resizer:hover { background: var(--primary-2); }
    .no-select { -webkit-user-select: none; user-select: none; }

    /* ====== Iframe styling ====== */
    #viewer {
        width: 100%;
        height: 100%;
        border: 0;
        background: white; /* Default background for loaded content */
        opacity: 0;
        transition: opacity 180ms ease-out;
    }
    #viewer.loaded {
        opacity: 1;
    }
  </style>
</head>

<body>
  <!-- App Shell -->
  <div class="app" id="app">
    <!-- Top bar -->
    <header class="topbar">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        App Launcher
      </div>
      <div class="spacer"></div>
      <div class="topbar-actions">
        <input id="file-input" type="file" accept=".html,.htm,text/html" multiple class="hidden" />
        <button id="btn-add" class="btn primary">+ Add HTML</button>
        <input id="session-input" type="file" accept="application/json" class="hidden" />
        <button id="btn-import" class="btn success">Import</button>
        <button id="btn-export" class="btn">Export</button>
        <button id="btn-clear" class="btn danger">Clear</button>
      </div>
    </header>

    <!-- Main area: sidebar | resizer | content -->
    <main class="main" id="main-container">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div id="dropzone" class="dropzone">
          <p><strong>Drop HTML files here</strong></p>
          <p class="muted">or click "+ Add HTML". Files are processed locally.</p>
        </div>
        <input id="search" type="text" placeholder="Search filesâ€¦" class="input" />
        <ul id="file-list" class="file-list" aria-label="Loaded HTML files"></ul>
      </aside>

      <!-- Resizer -->
      <div id="resizer" class="resizer" title="Drag to resize sidebar"></div>

      <!-- Content Viewer -->
      <section class="content">
        <div class="content-header">
          <div id="current-file" class="muted">No file selected</div>
          <div class="actions">
            <button id="btn-open-new" class="btn">Open in New Tab</button>
            <button id="btn-refresh" class="btn">Refresh</button>
            <button id="btn-remove" class="btn">Remove</button>
          </div>
        </div>
        <div class="content-body">
          <iframe id="viewer" sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-downloads" title="HTML preview"></iframe>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =========================
    // App State & Utilities
    // =========================
    const App = {
      files: [], // Array of { id, name, alias, size, mtime, text, url }
      selectedIndex: -1,
      swapCounter: 0,

      // DOM element references
      el: {
        fileInput: document.getElementById('file-input'),
        sessionInput: document.getElementById('session-input'),
        addBtn: document.getElementById('btn-add'),
        importBtn: document.getElementById('btn-import'),
        exportBtn: document.getElementById('btn-export'),
        clearBtn: document.getElementById('btn-clear'),
        list: document.getElementById('file-list'),
        search: document.getElementById('search'),
        viewer: document.getElementById('viewer'),
        currentFile: document.getElementById('current-file'),
        openNewBtn: document.getElementById('btn-open-new'),
        refreshBtn: document.getElementById('btn-refresh'),
        removeBtn: document.getElementById('btn-remove'),
        dropzone: document.getElementById('dropzone'),
        sidebar: document.getElementById('sidebar'),
        resizer: document.getElementById('resizer'),
        main: document.getElementById('main-container'),
      },

      // Generates a unique ID for each file
      uid: () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4),

      // Safely revokes a Blob URL to free up memory
      revokeUrl(url) {
        try { if (url) URL.revokeObjectURL(url); } catch (_) {}
      },

      // Creates a new Blob URL from file content
      makeUrlFromText(text) {
        const blob = new Blob([text], { type: 'text/html' });
        return URL.createObjectURL(blob);
      },
    };

    // =========================
    // Core Logic
    // =========================

    /**
     * Renders the list of files in the sidebar, applying any search filter.
     */
    function renderList() {
      const query = App.el.search.value.trim().toLowerCase();
      App.el.list.innerHTML = ''; // Clear current list

      App.files.forEach((file, index) => {
        const label = (file.alias || file.name).toLowerCase();
        if (query && !label.includes(query)) return; // Skip if it doesn't match search

        const li = document.createElement('li');
        li.className = 'file-item';

        const isSelected = index === App.selectedIndex;
        const row = document.createElement('button');
        row.className = isSelected ? 'active' : '';
        row.title = `${file.name} (double-click to rename)`;
        row.addEventListener('click', () => selectIndex(index));
        row.addEventListener('dblclick', () => promptRename(index));

        // File name and metadata
        const nameDiv = document.createElement('div');
        nameDiv.className = 'name';
        nameDiv.innerHTML = `
          <div class="main-name">${file.alias || file.name}</div>
          <div class="meta">${(file.size / 1024).toFixed(1)} KB â€¢ ${new Date(file.mtime).toLocaleString()}</div>
        `;

        // Action buttons (Open, Remove)
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'actions';
        actionsDiv.innerHTML = `
          <button class="open-action">Open</button>
          <button class="remove-action">âœ•</button>
        `;
        actionsDiv.querySelector('.open-action').addEventListener('click', (e) => { e.stopPropagation(); openInNewTab(index); });
        actionsDiv.querySelector('.remove-action').addEventListener('click', (e) => { e.stopPropagation(); removeIndex(index); });

        row.appendChild(nameDiv);
        row.appendChild(actionsDiv);
        li.appendChild(row);
        App.el.list.appendChild(li);
      });
    }

    /**
     * Swaps the iframe with a new one to ensure a clean environment for each app.
     * This is more robust than just changing the `src` or `srcdoc`.
     * @param {string} html - The HTML content to load into the new iframe.
     */
    function swapIframeWithHtml(html) {
      const seq = ++App.swapCounter;
      const oldIframe = App.el.viewer;

      // Fade out the old iframe
      oldIframe.classList.remove('loaded');

      setTimeout(() => {
        if (seq !== App.swapCounter) return; // A newer swap has started

        const newIframe = document.createElement('iframe');
        newIframe.id = 'viewer';
        newIframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-downloads');
        newIframe.setAttribute('title', 'HTML preview');

        // Replace the old iframe in the DOM
        oldIframe.replaceWith(newIframe);
        App.el.viewer = newIframe; // Update the reference

        // Load the new content and fade it in
        newIframe.srcdoc = html || '';
        newIframe.onload = () => {
            // Use a different background for the iframe if the loaded doc has a dark theme
            const doc = newIframe.contentDocument;
            if (doc && (doc.body.classList.contains('dark') || doc.documentElement.getAttribute('data-theme') === 'dark')) {
                newIframe.style.background = 'var(--bg)';
            } else {
                newIframe.style.background = 'white';
            }
            newIframe.classList.add('loaded');
        };
      }, 180);
    }

    /**
     * Selects a file by its index, updates the UI, and loads it into the viewer.
     * @param {number} index - The index of the file to select.
     */
    function selectIndex(index) {
      if (index < 0 || index >= App.files.length) return;
      App.selectedIndex = index;
      const file = App.files[index];
      App.el.currentFile.textContent = file ? (file.alias || file.name) : 'No file selected';
      swapIframeWithHtml(file.text);
      renderList();
    }

    /**
     * Shows a placeholder in the viewer when no file is selected.
     */
    function showPlaceholder() {
      const placeholderHtml = `<!DOCTYPE html><html><body style="margin:0;min-height:100vh;display:grid;place-items:center;background:#0f1115;color:#a3aab8;font-family:inherit;text-align:center;"><div>Load an HTML file to begin.</div></body></html>`;
      swapIframeWithHtml(placeholderHtml);
      App.el.currentFile.textContent = 'No file selected';
    }

    /**
     * Reads a list of File objects, processes them, and adds them to the state.
     * @param {FileList} fileList - The list of files from an input or drop event.
     */
    async function addFiles(fileList) {
      const htmlFiles = Array.from(fileList || []).filter(f => /\.(html?|txt)$/i.test(f.name));
      if (!htmlFiles.length) return;

      const newEntries = await Promise.all(htmlFiles.map(async (f) => {
        const text = await f.text().catch(() => '');
        return {
          id: App.uid(),
          name: f.name,
          alias: f.name,
          size: f.size,
          mtime: f.lastModified || Date.now(),
          text,
          url: App.makeUrlFromText(text),
        };
      }));

      App.files.push(...newEntries);
      selectIndex(App.files.length - 1); // Select the last added file
    }

    /**
     * Removes a file from the list by its index.
     * @param {number} index - The index of the file to remove.
     */
    function removeIndex(index) {
      const file = App.files[index];
      if (!file) return;

      App.revokeUrl(file.url);
      App.files.splice(index, 1);

      if (App.selectedIndex >= App.files.length) {
        App.selectedIndex = App.files.length - 1;
      }

      if (App.selectedIndex === index || App.selectedIndex === -1) {
        if (App.files.length > 0) {
          selectIndex(App.selectedIndex);
        } else {
          showPlaceholder();
          renderList();
        }
      } else {
        renderList();
      }
    }

    /**
     * Opens the currently selected file in a new browser tab.
     * @param {number} index - The index of the file to open.
     */
    function openInNewTab(index = App.selectedIndex) {
      const file = App.files[index];
      if (!file) return;
      // Re-create the URL on demand to ensure it's fresh
      const url = App.makeUrlFromText(file.text);
      window.open(url, '_blank');
      // We don't revoke this one immediately, as the new tab needs it.
    }

    /**
     * Refreshes the viewer with the current file's content.
     */
    function refreshSelected() {
      if (App.selectedIndex >= 0) {
        selectIndex(App.selectedIndex);
      }
    }

    /**
     * Prompts the user to enter a new alias for a file.
     * @param {number} index - The index of the file to rename.
     */
    function promptRename(index) {
      const file = App.files[index];
      if (!file) return;
      const newAlias = prompt('Rename (alias):', file.alias || file.name);
      if (newAlias === null) return; // User cancelled
      file.alias = newAlias.trim() || file.name;
      renderList();
      if (index === App.selectedIndex) {
        App.el.currentFile.textContent = file.alias;
      }
    }
    
    /**
     * Clears all loaded files and resets the UI.
     */
    function clearAll() {
        if (!confirm('Are you sure you want to remove all loaded files?')) return;
        App.files.forEach(f => App.revokeUrl(f.url));
        App.files = [];
        App.selectedIndex = -1;
        renderList();
        showPlaceholder();
    }

    // =========================
    // Session Import/Export
    // =========================

    function exportSession() {
      if (!App.files.length) {
        alert('No files to export.');
        return;
      }
      const data = {
        version: 1,
        exportedAt: Date.now(),
        files: App.files.map(f => ({ name: f.name, alias: f.alias, text: f.text }))
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'app-launcher-session.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importSessionFile(file) {
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || !Array.isArray(data.files)) throw new Error('Invalid session file format.');

        const newEntries = data.files.map(item => ({
          id: App.uid(),
          name: item.name || 'imported.html',
          alias: item.alias || item.name || 'imported.html',
          size: (item.text || '').length,
          mtime: Date.now(),
          text: String(item.text || ''),
          url: App.makeUrlFromText(String(item.text || '')),
        }));

        App.files.push(...newEntries);
        selectIndex(App.files.length - 1);
      } catch (e) {
        alert(`Failed to import session: ${e.message}`);
      }
    }


    // =========================
    // Event Wiring
    // =========================

    function initEventListeners() {
      // Top bar buttons
      App.el.addBtn.addEventListener('click', () => App.el.fileInput.click());
      App.el.fileInput.addEventListener('change', (e) => { addFiles(e.target.files); e.target.value = ''; });
      App.el.importBtn.addEventListener('click', () => App.el.sessionInput.click());
      App.el.sessionInput.addEventListener('change', (e) => { if (e.target.files[0]) importSessionFile(e.target.files[0]); e.target.value = ''; });
      App.el.exportBtn.addEventListener('click', exportSession);
      App.el.clearBtn.addEventListener('click', clearAll);

      // Search
      App.el.search.addEventListener('input', renderList);

      // Viewer controls
      App.el.openNewBtn.addEventListener('click', () => openInNewTab());
      App.el.refreshBtn.addEventListener('click', refreshSelected);
      App.el.removeBtn.addEventListener('click', () => removeIndex(App.selectedIndex));

      // Drag and drop
      const dz = App.el.dropzone;
      ['dragenter', 'dragover'].forEach(type => dz.addEventListener(type, e => {
        e.preventDefault(); e.stopPropagation(); dz.classList.add('active');
      }));
      ['dragleave', 'drop'].forEach(type => dz.addEventListener(type, e => {
        e.preventDefault(); e.stopPropagation(); dz.classList.remove('active');
      }));
      dz.addEventListener('drop', e => { if (e.dataTransfer) addFiles(e.dataTransfer.files); });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        const isTyping = e.target.matches('input, textarea');
        if (e.ctrlKey && !e.shiftKey && !e.altKey && e.key.toLowerCase() === 'o') {
          e.preventDefault(); App.el.fileInput.click();
        }
        if (isTyping) return;

        if (e.altKey && e.key === 'ArrowRight') {
          e.preventDefault(); if (App.files.length) selectIndex((App.selectedIndex + 1) % App.files.length);
        }
        if (e.altKey && e.key === 'ArrowLeft') {
          e.preventDefault(); if (App.files.length) selectIndex((App.selectedIndex - 1 + App.files.length) % App.files.length);
        }
        if (e.key === 'Enter') {
          e.preventDefault(); openInNewTab();
        }
        if (e.key === 'Delete' || e.key === 'Backspace') {
          e.preventDefault(); if (App.selectedIndex >= 0) removeIndex(App.selectedIndex);
        }
        if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'r') {
          e.preventDefault(); refreshSelected();
        }
      });

      // Sidebar resizer
      (function enableResizer() {
        let dragging = false;
        App.el.resizer.addEventListener('pointerdown', (e) => {
          dragging = true;
          App.el.resizer.setPointerCapture(e.pointerId);
          document.body.classList.add('no-select');
        });
        window.addEventListener('pointermove', (e) => {
          if (!dragging) return;
          const rect = App.el.main.getBoundingClientRect();
          const newWidth = e.clientX - rect.left;
          App.el.sidebar.style.width = `${Math.max(220, Math.min(newWidth, 560))}px`;
        });
        window.addEventListener('pointerup', (e) => {
          if (!dragging) return;
          dragging = false;
          App.el.resizer.releasePointerCapture(e.pointerId);
          document.body.classList.remove('no-select');
        });
      })();
    }

    // =========================
    // App Initialization
    // =========================
    (function main() {
      initEventListeners();
      showPlaceholder();
      renderList();
    })();
  </script>
</body>
</html>
