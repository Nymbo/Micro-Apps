<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Library Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-dark: #0a0b10;
      --bg-panel: #12141c;
      --bg-panel-trans: rgba(18, 20, 28, 0.8);
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --accent: #8b5cf6;
      --text-main: #f3f4f6;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.05);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --sidebar-width: 260px;
      --player-height: 90px;
    }

    * {
      box-sizing: border-box;
      outline: none;
    }

    body {
      margin: 0;
      background-color: var(--bg-dark);
      background-image:
        radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.08), transparent 25%);
      color: var(--text-main);
      font-family: 'Outfit', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4b5563;
    }

    /* Layout */
    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: calc(100vh - var(--player-height));
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-panel-trans);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      z-index: 10;
      position: relative;
      min-width: 150px;
      max-width: 600px;
    }

    .brand {
      padding: 24px;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(to right, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
    }

    .nav-menu {
      list-style: none;
      padding: 0 12px;
      margin: 0;
    }

    .nav-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-item:hover {
      background: var(--glass);
      color: var(--text-main);
    }

    .nav-item.active {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .library-tree {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      margin-top: 12px;
      border-top: 1px solid var(--border);
    }

    /* Resizer */
    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      z-index: 100;
      transition: background 0.2s;
    }

    .resizer:hover,
    .resizer.active {
      background: var(--primary);
    }

    /* Tree Toolbar */
    .tree-toolbar {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--glass-border);
    }

    .tree-tool-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      border-radius: 4px;
      padding: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .tree-tool-btn:hover {
      background: var(--glass);
      color: var(--text-main);
      border-color: var(--text-muted);
    }

    /* Tree View Styles */
    .tree-item {
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tree-item:hover {
      background: var(--glass);
      color: var(--text-main);
    }

    .tree-children {
      padding-left: 12px;
      border-left: 1px solid var(--glass-border);
      margin-left: 6px;
    }

    .tree-children.hidden {
      display: none;
    }

    .tree-toggle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.7rem;
      transition: transform 0.2s;
    }

    .tree-toggle:hover {
      color: var(--text-main);
    }

    .tree-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .tree-folder-icon {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .top-bar {
      height: 70px;
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(10, 11, 16, 0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .search-box {
      position: relative;
      width: 300px;
    }

    .search-input {
      width: 100%;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      padding: 10px 16px 10px 40px;
      border-radius: 24px;
      color: var(--text-main);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      fill: var(--text-muted);
      pointer-events: none;
    }

    .view-container {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    /* Track List */
    .track-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .track-row {
      display: grid;
      grid-template-columns: 40px 1fr 1fr 80px 60px;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      align-items: center;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s;
      font-size: 0.95rem;
    }

    .track-row:hover {
      background: var(--glass);
    }

    .track-row.playing {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .track-row.playing .track-num {
      display: none;
    }

    .track-row.playing .playing-icon {
      display: block;
    }

    .track-head {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 8px;
      cursor: default;
    }

    .track-head:hover {
      background: transparent;
    }

    .track-title {
      color: var(--text-main);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-artist {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-duration {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .track-num {
      text-align: center;
      font-size: 0.85rem;
    }

    .playing-icon {
      display: none;
      width: 16px;
      height: 16px;
      fill: var(--primary);
      animation: pulse 1.5s infinite;
    }

    .track-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .track-row:hover .track-actions {
      opacity: 1;
    }

    .action-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .action-btn:hover {
      color: var(--text-main);
      background: rgba(255, 255, 255, 0.1);
    }

    .action-btn.active {
      color: var(--primary);
      fill: var(--primary);
    }

    /* Stats View */
    .stats-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .stat-val {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .chart-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: var(--radius-lg);
      height: 350px;
      display: flex;
      flex-direction: column;
    }

    .chart-card.large {
      grid-column: span 2;
    }

    .chart-card h3 {
      margin: 0 0 16px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    /* Player Bar */
    .player-bar {
      height: var(--player-height);
      background: var(--bg-panel);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 20;
      justify-content: space-between;
    }

    .now-playing {
      width: 25%;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .album-art-placeholder {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
    }

    .track-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }

    .np-title {
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .np-artist {
      color: var(--text-muted);
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-controls {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      max-width: 600px;
    }

    .control-buttons {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .ctrl-btn {
      background: transparent;
      border: none;
      color: var(--text-main);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .ctrl-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .ctrl-btn.play-pause {
      background: var(--text-main);
      color: var(--bg-dark);
      width: 40px;
      height: 40px;
    }

    .ctrl-btn.play-pause:hover {
      transform: scale(1.05);
      background: white;
    }

    .progress-container {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
      width: 0%;
    }

    .progress-handle {
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%) scale(0);
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      transition: transform 0.1s;
    }

    .progress-bar:hover .progress-handle {
      transform: translateY(-50%) scale(1);
    }

    .volume-controls {
      width: 25%;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }

    .volume-slider {
      width: 100px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .volume-slider .progress-fill {
      width: 100%;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--text-muted);
    }

    .empty-state h2 {
      color: var(--text-main);
      margin-bottom: 8px;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
    }
  </style>
</head>

<body>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="resizer" id="resizer"></div>
      <div class="brand">Music Player</div>
      <ul class="nav-menu">
        <li class="nav-item active" data-view="library">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
          </svg>
          Library
        </li>
        <li class="nav-item" data-view="stats">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
          </svg>
          Stats
        </li>
      </ul>
      <div class="tree-toolbar">
        <button class="tree-tool-btn" id="expandAllBtn" title="Expand All">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
        </button>
        <button class="tree-tool-btn" id="collapseAllBtn" title="Collapse All">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13H5v-2h14v2z" />
          </svg>
        </button>
        <button class="tree-tool-btn" id="expandArtistsBtn" title="Expand Artists Only">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
        </button>
      </div>
      <div class="library-tree" id="folderTree">
        <!-- Tree content populated by JS -->
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-bar">
        <div class="search-box">
          <svg class="search-icon" viewBox="0 0 24 24">
            <path
              d="M15.5 14h-.79l-.28-.28C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.28.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
          </svg>
          <input type="text" class="search-input" placeholder="Search tracks, artists..." id="searchInput">
        </div>
        <button class="btn-primary" id="selectFolderBtn">Select Folder</button>
        <input type="file" id="folderInput" webkitdirectory multiple hidden>
      </div>

      <div class="view-container" id="viewContainer">
        <!-- Views injected here -->
        <div class="empty-state">
          <h2>No Music Loaded</h2>
          <p>Select a folder to scan your local library.</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Player Bar -->
  <footer class="player-bar">
    <div class="now-playing">
      <div class="album-art-placeholder" id="npArt">ðŸŽµ</div>
      <div class="track-info">
        <div class="np-title" id="npTitle">Not Playing</div>
        <div class="np-artist" id="npArtist">-</div>
      </div>
    </div>

    <div class="player-controls">
      <div class="control-buttons">
        <button class="ctrl-btn" id="prevBtn" title="Previous">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
          </svg>
        </button>
        <button class="ctrl-btn play-pause" id="playPauseBtn" title="Play/Pause">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="playIcon">
            <path d="M8 5v14l11-7z" />
          </svg>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="pauseIcon" class="hidden">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
          </svg>
        </button>
        <button class="ctrl-btn" id="nextBtn" title="Next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
          </svg>
        </button>
      </div>
      <div class="progress-container">
        <span id="currentTime">0:00</span>
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
          <div class="progress-handle"></div>
        </div>
        <span id="duration">0:00</span>
      </div>
    </div>

    <div class="volume-controls">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
      </svg>
      <div class="volume-slider" id="volumeSlider">
        <div class="progress-fill" id="volumeFill"></div>
      </div>
    </div>
  </footer>

  <script>
    // --- App State ---
    const state = {
      files: [],
      filteredFiles: [],
      currentTrackIndex: -1,
      isPlaying: false,
      volume: 1,
      view: 'library',
      audio: new Audio(),
      folderTree: new Map(),
      favorites: new Set(JSON.parse(localStorage.getItem('music_favorites') || '[]'))
    };

    // --- DOM Elements ---
    const els = {
      folderInput: document.getElementById('folderInput'),
      selectFolderBtn: document.getElementById('selectFolderBtn'),
      viewContainer: document.getElementById('viewContainer'),
      folderTree: document.getElementById('folderTree'),
      searchInput: document.getElementById('searchInput'),
      navItems: document.querySelectorAll('.nav-item'),

      // Sidebar
      sidebar: document.getElementById('sidebar'),
      resizer: document.getElementById('resizer'),
      expandAllBtn: document.getElementById('expandAllBtn'),
      collapseAllBtn: document.getElementById('collapseAllBtn'),
      expandArtistsBtn: document.getElementById('expandArtistsBtn'),

      // Player
      playPauseBtn: document.getElementById('playPauseBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      playIcon: document.getElementById('playIcon'),
      pauseIcon: document.getElementById('pauseIcon'),
      progressBar: document.getElementById('progressBar'),
      progressFill: document.getElementById('progressFill'),
      currentTime: document.getElementById('currentTime'),
      duration: document.getElementById('duration'),
      volumeSlider: document.getElementById('volumeSlider'),
      volumeFill: document.getElementById('volumeFill'),

      // Now Playing
      npTitle: document.getElementById('npTitle'),
      npArtist: document.getElementById('npArtist'),
      npArt: document.getElementById('npArt')
    };

    // --- Initialization ---
    els.selectFolderBtn.addEventListener('click', () => els.folderInput.click());
    els.folderInput.addEventListener('change', handleFolderSelect);

    els.playPauseBtn.addEventListener('click', togglePlay);
    els.prevBtn.addEventListener('click', playPrev);
    els.nextBtn.addEventListener('click', playNext);

    state.audio.addEventListener('timeupdate', updateProgress);
    state.audio.addEventListener('ended', playNext);

    state.audio.addEventListener('loadedmetadata', () => {
      els.duration.textContent = formatTime(state.audio.duration);
    });

    els.progressBar.addEventListener('click', seek);
    els.volumeSlider.addEventListener('click', setVolume);
    els.searchInput.addEventListener('input', handleSearch);

    els.navItems.forEach(item => {
      item.addEventListener('click', () => {
        els.navItems.forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        state.view = item.dataset.view;
        renderView();
      });
    });

    // Sidebar Resizing
    let isResizing = false;
    els.resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      els.resizer.classList.add('active');
      document.body.style.cursor = 'col-resize';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const newWidth = Math.max(150, Math.min(600, e.clientX));
      document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
    });

    document.addEventListener('mouseup', () => {
      isResizing = false;
      els.resizer.classList.remove('active');
      document.body.style.cursor = 'default';
    });

    // Tree Controls
    els.expandAllBtn.addEventListener('click', () => toggleTree(true));
    els.collapseAllBtn.addEventListener('click', () => toggleTree(false));
    els.expandArtistsBtn.addEventListener('click', expandArtists);

    function toggleTree(expand) {
      const children = els.folderTree.querySelectorAll('.tree-children');
      const toggles = els.folderTree.querySelectorAll('.tree-toggle');

      children.forEach(el => {
        if (expand) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });

      toggles.forEach(el => {
        if (expand) el.classList.remove('collapsed');
        else el.classList.add('collapsed');
      });
    }

    function expandArtists() {
      toggleTree(false); // Collapse all first
      // Expand top level only
      const topLevel = els.folderTree.children; // These are the root nodes
      Array.from(topLevel).forEach(root => {
        // The root itself is a div containing tree-item and tree-children
        // We want to expand its immediate children
        const childrenContainer = root.querySelector('.tree-children');
        const toggle = root.querySelector('.tree-toggle');
        if (childrenContainer) childrenContainer.classList.remove('hidden');
        if (toggle) toggle.classList.remove('collapsed');
      });
    }

    // --- Core Logic ---

    async function handleFolderSelect(e) {
      const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.mp3'));
      if (!files.length) return alert('No MP3 files found.');

      state.files = files.map((f, i) => ({
        file: f,
        id: i,
        name: f.name.replace('.mp3', ''),
        artist: getArtistFromPath(f) || 'Unknown Artist',
        path: f.webkitRelativePath,
        url: URL.createObjectURL(f)
      }));

      state.filteredFiles = [...state.files];
      buildTree(state.files);
      renderView();
      renderTree();
    }

    function getArtistFromPath(file) {
      const parts = file.webkitRelativePath.split('/');
      return parts.length > 2 ? parts[1] : null;
    }

    function buildTree(files) {
      state.folderTree = new Map();

      files.forEach(track => {
        const parts = track.path.split('/');
        parts.pop(); // remove filename

        let currentLevel = state.folderTree;
        parts.forEach(part => {
          if (!currentLevel.has(part)) {
            currentLevel.set(part, new Map());
          }
          currentLevel = currentLevel.get(part);
        });
      });
    }

    function toggleFavorite(trackName, btn) {
      if (state.favorites.has(trackName)) {
        state.favorites.delete(trackName);
        btn.classList.remove('active');
      } else {
        state.favorites.add(trackName);
        btn.classList.add('active');
      }
      localStorage.setItem('music_favorites', JSON.stringify(Array.from(state.favorites)));
    }

    // --- Playback ---

    function loadTrack(index) {
      if (index < 0 || index >= state.filteredFiles.length) return;

      state.currentTrackIndex = index;
      const track = state.filteredFiles[index];

      state.audio.src = track.url;
      state.audio.play().catch(e => console.error("Playback failed", e));
      state.isPlaying = true;

      updatePlayerUI(track);
      updatePlayPauseIcon();
      renderTrackList(); // Update active state in list
    }

    function togglePlay() {
      if (state.currentTrackIndex === -1 && state.filteredFiles.length > 0) {
        loadTrack(0);
        return;
      }

      if (state.audio.paused) {
        state.audio.play();
        state.isPlaying = true;
      } else {
        state.audio.pause();
        state.isPlaying = false;
      }
      updatePlayPauseIcon();
    }

    function playNext() {
      let nextIndex = state.currentTrackIndex + 1;
      if (nextIndex >= state.filteredFiles.length) nextIndex = 0; // Loop
      loadTrack(nextIndex);
    }

    function playPrev() {
      let prevIndex = state.currentTrackIndex - 1;
      if (prevIndex < 0) prevIndex = state.filteredFiles.length - 1;
      loadTrack(prevIndex);
    }

    function seek(e) {
      if (!state.audio.duration) return;
      const rect = els.progressBar.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      state.audio.currentTime = percent * state.audio.duration;
    }

    function setVolume(e) {
      const rect = els.volumeSlider.getBoundingClientRect();
      let percent = (e.clientX - rect.left) / rect.width;
      percent = Math.max(0, Math.min(1, percent));

      state.volume = percent;
      state.audio.volume = percent;
      els.volumeFill.style.width = (percent * 100) + '%';
    }

    function updateProgress() {
      const { currentTime, duration } = state.audio;
      if (!duration) return;

      const percent = (currentTime / duration) * 100;
      els.progressFill.style.width = percent + '%';
      els.currentTime.textContent = formatTime(currentTime);
    }

    function updatePlayerUI(track) {
      els.npTitle.textContent = track.name;
      els.npArtist.textContent = track.artist;
      els.npArt.textContent = track.name.charAt(0).toUpperCase();
    }

    function updatePlayPauseIcon() {
      if (state.isPlaying) {
        els.playIcon.classList.add('hidden');
        els.pauseIcon.classList.remove('hidden');
      } else {
        els.playIcon.classList.remove('hidden');
        els.pauseIcon.classList.add('hidden');
      }
    }

    // --- Rendering ---

    function renderView() {
      els.viewContainer.innerHTML = '';

      if (state.files.length === 0) {
        els.viewContainer.innerHTML = `
          <div class="empty-state">
            <h2>No Music Loaded</h2>
            <p>Select a folder to scan your local library.</p>
          </div>`;
        return;
      }

      if (state.view === 'library') {
        renderTrackList();
      } else if (state.view === 'stats') {
        renderStats();
      }
    }

    function renderTrackList() {
      const list = document.createElement('div');
      list.className = 'track-list';

      // Header
      const header = document.createElement('div');
      header.className = 'track-row track-head';
      header.innerHTML = `
        <div>#</div>
        <div>Title</div>
        <div>Artist</div>
        <div class="track-duration">Duration</div>
        <div></div>
      `;
      list.appendChild(header);

      // Tracks
      state.filteredFiles.forEach((track, index) => {
        const row = document.createElement('div');
        const isPlaying = index === state.currentTrackIndex;
        const isFav = state.favorites.has(track.name);

        row.className = `track-row ${isPlaying ? 'playing' : ''}`;

        // Click on row plays track
        row.addEventListener('click', (e) => {
          if (e.target.closest('.action-btn')) return; // Don't play if clicking heart
          loadTrack(index);
        });

        row.innerHTML = `
          <div class="track-num">${index + 1}</div>
          <svg class="playing-icon" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
          <div class="track-title">${track.name}</div>
          <div class="track-artist">${track.artist}</div>
          <div class="track-duration">--:--</div>
          <div class="track-actions">
            <button class="action-btn ${isFav ? 'active' : ''}" title="Like">â™¥</button>
          </div>
        `;

        const favBtn = row.querySelector('.action-btn');
        favBtn.onclick = () => toggleFavorite(track.name, favBtn);

        list.appendChild(row);
      });

      els.viewContainer.innerHTML = '';
      els.viewContainer.appendChild(list);
    }

    function renderStats() {
      const artistCounts = {};
      const sizeDistribution = { 'Small (<3MB)': 0, 'Medium (3-8MB)': 0, 'Large (>8MB)': 0 };
      const folderDepths = {};

      state.files.forEach(f => {
        // Artist Stats
        artistCounts[f.artist] = (artistCounts[f.artist] || 0) + 1;

        // Size Stats
        const sizeMB = f.file.size / (1024 * 1024);
        if (sizeMB < 3) sizeDistribution['Small (<3MB)']++;
        else if (sizeMB < 8) sizeDistribution['Medium (3-8MB)']++;
        else sizeDistribution['Large (>8MB)']++;

        // Folder Depth Stats
        const depth = f.path.split('/').length - 1;
        folderDepths[depth] = (folderDepths[depth] || 0) + 1;
      });

      const topArtists = Object.entries(artistCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      els.viewContainer.innerHTML = `
        <div class="stats-header">
          <div class="stat-card">
            <div class="stat-val">${state.files.length}</div>
            <div class="stat-label">Total Tracks</div>
          </div>
          <div class="stat-card">
            <div class="stat-val">${Object.keys(artistCounts).length}</div>
            <div class="stat-label">Unique Artists</div>
          </div>
          <div class="stat-card">
            <div class="stat-val">${formatBytes(state.files.reduce((a, b) => a + b.file.size, 0))}</div>
            <div class="stat-label">Total Size</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-card large">
            <h3>Top Artists by Track Count</h3>
            <div class="chart-wrapper"><canvas id="artistChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>File Size Distribution</h3>
            <div class="chart-wrapper"><canvas id="sizeChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>Folder Depth Analysis</h3>
            <div class="chart-wrapper"><canvas id="depthChart"></canvas></div>
          </div>
        </div>
      `;

      // Render Charts
      setTimeout(() => {
        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#9ca3af' } }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } },
            x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
          }
        };

        // Artist Chart
        new Chart(document.getElementById('artistChart'), {
          type: 'bar',
          data: {
            labels: topArtists.map(a => a[0]),
            datasets: [{
              label: 'Tracks',
              data: topArtists.map(a => a[1]),
              backgroundColor: '#6366f1',
              borderRadius: 4
            }]
          },
          options: commonOptions
        });

        // Size Chart
        new Chart(document.getElementById('sizeChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(sizeDistribution),
            datasets: [{
              data: Object.values(sizeDistribution),
              backgroundColor: ['#8b5cf6', '#6366f1', '#ec4899'],
              borderWidth: 0
            }]
          },
          options: {
            ...commonOptions,
            scales: { x: { display: false }, y: { display: false } }
          }
        });

        // Depth Chart
        new Chart(document.getElementById('depthChart'), {
          type: 'line',
          data: {
            labels: Object.keys(folderDepths).map(d => `Level ${d}`),
            datasets: [{
              label: 'Files at Depth',
              data: Object.values(folderDepths),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: commonOptions
        });
      }, 0);
    }

    function renderTree() {
      els.folderTree.innerHTML = '';

      function createNode(map, name) {
        const div = document.createElement('div');

        if (name) {
          const item = document.createElement('div');
          item.className = 'tree-item tree-folder';

          // Toggle Arrow
          const toggle = document.createElement('div');
          toggle.className = 'tree-toggle';
          toggle.textContent = 'â–¼';

          const icon = document.createElement('span');
          icon.className = 'tree-folder-icon';
          icon.textContent = 'ðŸ“';

          const label = document.createElement('span');
          label.textContent = name;

          item.appendChild(toggle);
          item.appendChild(icon);
          item.appendChild(label);

          div.appendChild(item);

          // Click on label filters
          label.onclick = (e) => {
            e.stopPropagation();
            els.searchInput.value = name;
            handleSearch({ target: { value: name } });
          };

          // Click on toggle expands/collapses
          toggle.onclick = (e) => {
            e.stopPropagation();
            const children = div.querySelector('.tree-children');
            if (children) {
              children.classList.toggle('hidden');
              toggle.classList.toggle('collapsed');
            }
          };
        }

        if (map.size > 0) {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'tree-children';
          // Default to expanded

          map.forEach((val, key) => {
            childrenContainer.appendChild(createNode(val, key));
          });

          div.appendChild(childrenContainer);
        }

        return div;
      }

      // Root level
      state.folderTree.forEach((val, key) => {
        els.folderTree.appendChild(createNode(val, key));
      });
    }

    function handleSearch(e) {
      const term = e.target.value.toLowerCase();
      if (!term) {
        state.filteredFiles = [...state.files];
      } else {
        state.filteredFiles = state.files.filter(t =>
          t.name.toLowerCase().includes(term) ||
          t.artist.toLowerCase().includes(term) ||
          t.path.toLowerCase().includes(term)
        );
      }
      if (state.view === 'library') renderTrackList();
    }

    // --- Helpers ---

    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function formatBytes(bytes, decimals = 2) {
      if (!+bytes) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

  </script>
</body>

</html>