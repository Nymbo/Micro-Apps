<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Markdown Studio</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-theme-dark">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme-light" disabled>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* ====== Design System (from App Template) ====== */
        :root {
            --bg: #0f1115;
            --panel: #151924;
            --panel-2: #0c0f16;
            --text: #e5e7eb;
            --text-muted: #a3aab8;
            --primary: #5b9cff;
            --primary-2: #2f6fe6;
            --primary-06: rgba(91,156,255,0.06);
            --primary-10: rgba(91,156,255,0.1);
            --primary-20: rgba(91,156,255,0.2);
            --border: #232836;
            --success: #22c55e;
            --danger: #ef4444;
            --shadow: rgba(0,0,0,0.4);
            --radius: 14px;
            --radius-sm: 10px;
            --pad: 14px;
        }

        [data-theme="light"] {
            --bg: #f5f7fb;
            --panel: #ffffff;
            --panel-2: #f3f5fa;
            --text: #0f172a;
            --text-muted: #475569;
            --primary: #2563eb;
            --primary-2: #1e40af;
            --primary-06: rgba(37,99,235,0.06);
            --primary-10: rgba(37,99,235,0.1);
            --primary-20: rgba(37,99,235,0.2);
            --border: #e5e7eb;
            --shadow: rgba(0,0,0,0.08);
        }

        /* ====== Global Resets & Typography ====== */
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: var(--bg); color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        /* Utility helpers */
        .muted { color: var(--text-muted); }
        .brand-hint { margin-left: 20px; }

        /* ====== App Shell Layout ====== */
        .app { display: flex; flex-direction: column; height: 100%; }
        .topbar {
            position: sticky; top: 0; z-index: 50; display: flex;
            align-items: center; gap: 10px; padding: var(--pad);
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0)), var(--panel-2);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
        }
        .brand {
            display: flex; align-items: center; gap: 10px;
            font-weight: 600; font-size: 16px;
        }
        .brand i { color: var(--primary); }
        .topbar-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; }

        .main { display: flex; flex: 1; overflow: hidden; }

        /* ====== Sidebar (File List) ====== */
        .sidebar {
            width: 280px; max-width: 40vw; flex-shrink: 0;
            background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .sidebar-header { padding: 12px; border-bottom: 1px solid var(--border); }
        .search-box {
            width: 100%; background: var(--panel-2);
            border: 1px solid var(--border); color: var(--text);
            padding: 10px 12px; border-radius: var(--radius-sm); font-size: 14px;
            outline: none; transition: border-color .2s ease, box-shadow .2s ease;
        }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-10); }

        .file-list { flex: 1; overflow-y: auto; padding: 8px; }
        .file-list::-webkit-scrollbar { width: 10px; }
        .file-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,.08); border: 2px solid transparent; background-clip: padding-box; border-radius: 8px; }
        .file-item {
            padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer;
            display: flex; align-items: center; gap: 10px; margin-bottom: 6px;
            border: 1px solid transparent; transition: background .2s, border-color .2s;
        }
        .file-item:hover { background: var(--panel-2); border-color: var(--primary-20); }
        .file-item.active { background: var(--panel-2); border-color: var(--primary); }
        .file-icon { color: var(--primary); opacity: .9; }

        /* ====== Editor & Preview Panes ====== */
        .editor-container { flex: 1; display: flex; overflow: hidden; }
        .editor-pane, .preview-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--panel); }
        .editor-pane { border-right: 1px solid var(--border); }

        .editor-header, .preview-header {
            padding: 10px 14px; background: var(--panel-2); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: var(--text-muted); flex-shrink: 0;
        }
        .editor-toolbar { display: flex; gap: 4px; }
        .toolbar-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer;
            padding: 6px 8px; border-radius: 8px; font-size: 14px; transition: all .2s;
        }
        .toolbar-btn:hover { background: var(--panel); color: var(--text); border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-10); }

        /* CodeMirror specific styles */
        .CodeMirror { flex: 1; height: auto; font-size: 15px; font-family: 'JetBrains Mono', monospace; }
        .CodeMirror-scrollbar-filler { background: transparent; }

        /* Preview content styles */
        .preview-content { flex: 1; overflow-y: auto; padding: 28px; background: var(--panel); }
        .preview-content::-webkit-scrollbar { width: 12px; }
        .preview-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,.08); border: 3px solid transparent; background-clip: padding-box; border-radius: 10px; }
        .preview-content > * { max-width: 900px; margin-left: auto; margin-right: auto; }
        .preview-content h1, .preview-content h2, .preview-content h3 { color: var(--text); margin-top: 24px; margin-bottom: 10px; }
        .preview-content h1 { font-size: 28px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .preview-content h2 { font-size: 22px; border-bottom: 1px dashed var(--border); padding-bottom: 6px; }
        .preview-content p { margin-bottom: 14px; line-height: 1.7; color: var(--text-muted); }
        .preview-content hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }
        .preview-content code { background: var(--panel-2); padding: 3px 6px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: .92em; border: 1px solid var(--border); }
        .preview-content pre { background: var(--panel-2); padding: 18px; border-radius: var(--radius); overflow: auto; margin-bottom: 18px; border: 1px solid var(--border); box-shadow: 0 10px 30px var(--shadow); }
        .preview-content pre code { background: none; padding: 0; border: none; }
        .preview-content blockquote { border-left: 4px solid var(--primary); padding-left: 16px; margin: 0 0 14px 0; color: var(--text-muted); background: var(--primary-06); border-radius: 8px; padding-top: 10px; padding-bottom: 10px; }
        .preview-content ul, .preview-content ol { padding-left: 24px; margin-bottom: 14px; color: var(--text-muted); }
        .preview-content a { color: var(--primary); text-decoration: none; }
        .preview-content a:hover { text-decoration: underline; }
        .preview-content img { max-width: 100%; border-radius: var(--radius-sm); margin: 12px 0; border: 1px solid var(--border); box-shadow: 0 10px 30px var(--shadow); }
        .preview-content table { border-collapse: collapse; width: 100%; margin-bottom: 16px; border: 1px solid var(--border); overflow: hidden; border-radius: var(--radius); }
        .preview-content th, .preview-content td { border-bottom: 1px solid var(--border); padding: 10px 12px; }
        .preview-content th { background: var(--panel-2); text-align: left; }
        .preview-content tr:hover td { background: var(--panel-2); }

        /* Resizer styles */
        .resize-handle { width: 8px; background: var(--panel-2); border-left: 1px solid var(--border); border-right: 1px solid var(--border); cursor: ew-resize; position: relative; transition: background .2s; }
        .resize-handle:hover { background: var(--panel); }
        .resize-handle::after { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 36px; border-radius: 2px; background: var(--primary); opacity: .5; transition: opacity .2s; }
        .resize-handle:hover::after { opacity: .9; }

        /* Reusable button styles */
        .btn {
            appearance: none; border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            color: var(--text); border-radius: var(--radius-sm);
            padding: 8px 12px; cursor: pointer; font-size: 14px;
            display: inline-flex; align-items: center; gap: 8px;
            transition: all .2s;
        }
        .btn:hover { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-10); transform: translateY(-1px); }
        .btn:active { transform: translateY(0px); }
        .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn.primary:hover { background: var(--primary-2); border-color: var(--primary-2); }

        /* Modal, Toasts, Command Palette */
        .modal-backdrop {
            position: fixed; inset: 0; display: none;
            background: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(3px); backdrop-filter: blur(3px);
            z-index: 80; align-items: center; justify-content: center;
        }
        .modal {
            width: min(420px, 96vw); background: var(--panel);
            border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: 0 18px 60px var(--shadow); overflow: hidden;
        }
        .modal-header, .modal-footer {
            padding: var(--pad); border-bottom: 1px solid var(--border); background: var(--panel-2);
        }
        .modal-footer { border-top: 1px solid var(--border); border-bottom: 0; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-body { padding: var(--pad); }
        .input-field {
            width: 100%; background: var(--panel-2); border: 1px solid var(--border); color: var(--text);
            padding: 10px; border-radius: var(--radius-sm); font-size: 14px; margin-bottom: 10px; outline: none;
        }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-10); }

        .toasts {
            position: fixed; bottom: 16px; right: 16px; z-index: 90;
            display: grid; gap: 10px; width: min(420px, 92vw);
        }
        .toast {
            background: var(--panel); border: 1px solid var(--border);
            border-left: 6px solid var(--primary); border-radius: var(--radius-sm);
            padding: 10px 12px; box-shadow: 0 12px 32px var(--shadow);
            display: flex; align-items: start; gap: 10px; color: var(--text);
        }
        .toast.success { border-left-color: var(--success); }
        .toast.danger { border-left-color: var(--danger); }

        .palette {
            position: fixed; inset: 0; display: none; z-index: 85;
            align-items: start; justify-content: center; padding-top: 10vh;
            background: rgba(0,0,0,0.35); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
        }
        .palette-panel {
            width: min(720px, 96vw); background: var(--panel);
            border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: 0 18px 60px var(--shadow); overflow: hidden;
        }
        .palette input {
            width: 100%; padding: 14px; background: var(--panel-2); color: var(--text);
            border: 0; outline: none; border-bottom: 1px solid var(--border); font-size: 15px;
        }
        .palette-list { max-height: 50vh; overflow: auto; }
        .palette-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .palette-item:hover { background: var(--primary-06); }
        .kbd {
            font-family: ui-monospace, 'JetBrains Mono', monospace; font-size: 12px; padding: 2px 6px;
            border: 1px solid var(--border); border-bottom-width: 2px; border-radius: 6px;
            background: var(--panel-2); color: var(--text-muted);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar { position: absolute; z-index: 60; width: 80%; height: 100%; transform: translateX(-100%); transition: transform .3s ease; }
            .sidebar.open { transform: translateX(0); box-shadow: 0 0 60px var(--shadow); }
            .editor-container { flex-direction: column; }
            .editor-pane { border-right: none; border-bottom: 1px solid var(--border); }
            .resize-handle { width: 100%; height: 8px; cursor: ns-resize; }
            .resize-handle::after { width: 36px; height: 2px; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="app">
        <header class="topbar">
            <div class="brand">
                <i class="fas fa-asterisk"></i> Markdown Studio
            </div>
            <div class="muted brand-hint">
                <span class="kbd">Ctrl</span>+<span class="kbd">K</span> for commands
            </div>
            <div class="topbar-actions">
                <button class="btn" id="new-note-btn">
                    <i class="fas fa-plus"></i> New Note
                </button>
                <button class="btn" id="save-note-btn">
                    <i class="fas fa-save"></i> Save
                </button>
                <button class="btn" id="theme-toggle-btn">
                    <i class="fas fa-sun"></i> Theme
                </button>
            </div>
        </header>

        <main class="main">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <input type="text" class="search-box" placeholder="Search notes..." id="search-input">
                </div>
                <div class="file-list" id="file-list">
                    </div>
            </aside>
            
            <div class="editor-container">
                <div class="editor-pane">
                    <div class="editor-header">
                        <div id="editor-title">Untitled.md</div>
                        <div class="editor-toolbar">
                            <button class="toolbar-btn" id="bold-btn" title="Bold"><i class="fas fa-bold"></i></button>
                            <button class="toolbar-btn" id="italic-btn" title="Italic"><i class="fas fa-italic"></i></button>
                            <button class="toolbar-btn" id="heading-btn" title="Heading"><i class="fas fa-heading"></i></button>
                            <button class="toolbar-btn" id="link-btn" title="Link"><i class="fas fa-link"></i></button>
                            <button class="toolbar-btn" id="code-btn" title="Code"><i class="fas fa-code"></i></button>
                            <button class="toolbar-btn" id="list-btn" title="List"><i class="fas fa-list-ul"></i></button>
                        </div>
                    </div>
                    <textarea id="markdown-editor" aria-label="Markdown editor"></textarea>
                </div>
                
                <div class="resize-handle" id="resize-handle"></div>
                
                <div class="preview-pane">
                    <div class="preview-header">
                        <i class="fas fa-eye"></i> Preview
                    </div>
                    <div class="preview-content" id="preview-content"></div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="modal-backdrop" id="new-note-modal">
        <div class="modal">
            <div class="modal-header"><strong>Create New Note</strong></div>
            <div class="modal-body">
                <input type="text" class="input-field" id="new-note-title" placeholder="Note title...">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-new-note">Cancel</button>
                <button class="btn primary" id="create-new-note">Create</button>
            </div>
        </div>
    </div>

    <div class="palette" id="palette">
        <div class="palette-panel">
            <input id="paletteInput" placeholder="Type a command…" />
            <div class="palette-list" id="paletteList"></div>
        </div>
    </div>

    <div class="toasts" id="toasts"></div>

<script>
    // Initialize helper functions
    const qs = (sel, el = document) => el.querySelector(sel);
    const qsa = (sel, el = document) => Array.from(el.querySelectorAll(sel));
    const on = (el, ev, fn) => el.addEventListener(ev, fn);

    // Main App Namespace
    window.App = {
        editor: null,
        isResizing: false,
        storageKey: 'markdownStudioState.v1',
        state: {
            theme: 'dark',
            notes: [],
            currentNoteId: null,
        },
        commands: [
            { label: 'Note: Create New', run: () => App.openNewNoteModal() },
            { label: 'Note: Save Current', run: () => App.saveCurrentNote() },
            { label: 'Theme: Toggle Dark/Light', run: () => App.toggleTheme() },
            { label: 'Search: Focus Search Bar', run: () => qs('#search-input').focus() },
        ],
    };

    // ====== State Management ======
    App.loadState = function() {
        try {
            const raw = localStorage.getItem(App.storageKey);
            if (raw) {
                App.state = { ...App.state, ...JSON.parse(raw) };
            }
        } catch (e) {
            console.warn('State load failed', e);
        }
    };

    App.saveState = function() {
        try {
            localStorage.setItem(App.storageKey, JSON.stringify(App.state));
        } catch (e) {
            console.warn('State save failed', e);
            App.toast('Error saving to localStorage.', 'danger');
        }
    };

    // ====== Theme Handling ======
    App.setTheme = function(theme) {
        App.state.theme = theme;
        document.body.setAttribute('data-theme', theme);
        qs('#theme-toggle-btn').innerHTML = theme === 'light' ? '<i class="fas fa-moon"></i> Theme' : '<i class="fas fa-sun"></i> Theme';
        
        // Toggle highlight.js theme
        qs('#hljs-theme-dark').disabled = theme === 'light';
        qs('#hljs-theme-light').disabled = theme === 'dark';
        
        App.saveState();
        App.renderPreview(); // Re-render preview to apply new syntax highlighting
    };

    App.toggleTheme = function() {
        App.setTheme(App.state.theme === 'dark' ? 'light' : 'dark');
    };

    // ====== Note Management ======
    App.renderFileList = function(filteredNotes = null) {
        const fileList = qs('#file-list');
        fileList.innerHTML = '';
        const notesToRender = filteredNotes || App.state.notes;

        notesToRender.forEach(note => {
            const item = document.createElement('div');
            item.className = `file-item ${note.id === App.state.currentNoteId ? 'active' : ''}`;
            item.innerHTML = `<i class="fas fa-file-alt file-icon"></i> <span>${note.title}.md</span>`;
            on(item, 'click', () => App.openNote(note.id));
            fileList.appendChild(item);
        });
    };

    App.createNote = function(title, content = '') {
        const newNote = {
            id: Date.now().toString(),
            title: title || 'Untitled',
            content: content,
        };
        App.state.notes.unshift(newNote);
        App.saveState();
        App.renderFileList();
        App.openNote(newNote.id);
    };

    App.openNote = function(noteId) {
        const note = App.state.notes.find(n => n.id === noteId);
        if (!note) return;
        
        App.state.currentNoteId = noteId;
        App.editor.setValue(note.content);
        qs('#editor-title').textContent = `${note.title}.md`;
        App.renderPreview();
        App.renderFileList();
        App.saveState();
    };

    App.saveCurrentNote = function() {
        if (!App.state.currentNoteId) return;
        const noteIndex = App.state.notes.findIndex(n => n.id === App.state.currentNoteId);
        if (noteIndex === -1) return;
        
        App.state.notes[noteIndex].content = App.editor.getValue();
        App.saveState();
        App.toast('Note saved!', 'success');
    };

    App.renderPreview = function() {
        const markdown = App.editor.getValue();
        qs('#preview-content').innerHTML = marked.parse(markdown);
    };

    // ====== UI Components (Modals, Toasts, Palette) ======
    App.toast = function(message, kind = 'info', timeout = 2200) {
        const wrap = qs('#toasts');
        const el = document.createElement('div');
        el.className = `toast ${kind}`;
        el.innerHTML = `<div>${message}</div>`;
        wrap.appendChild(el);
        setTimeout(() => el.remove(), timeout);
    };

    App.openNewNoteModal = function() {
        const modal = qs('#new-note-modal');
        modal.style.display = 'flex';
        qs('#new-note-title').focus();
    };

    App.closeNewNoteModal = function() {
        qs('#new-note-modal').style.display = 'none';
        qs('#new-note-title').value = '';
    };

    App.openPalette = function() {
        const pal = qs('#palette');
        const list = qs('#paletteList');
        list.innerHTML = '';
        App.commands.forEach((cmd, i) => {
            const item = document.createElement('div');
            item.className = 'palette-item';
            item.textContent = cmd.label;
            item.dataset.index = i;
            list.appendChild(item);
        });
        pal.style.display = 'flex';
        qs('#paletteInput').value = '';
        qs('#paletteInput').focus();
    };
    
    App.closePalette = function() { qs('#palette').style.display = 'none'; };

    App.filterPalette = function(text) {
        qsa('.palette-item', qs('#paletteList')).forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(text.toLowerCase()) ? '' : 'none';
        });
    };
    
    App.runPaletteItem = function(index) {
        if (App.commands[index]) {
            App.commands[index].run();
            App.closePalette();
        }
    };

    // ====== Event Listener Setup ======
    App.setupEventListeners = function() {
        // Top Bar
        on(qs('#new-note-btn'), 'click', App.openNewNoteModal);
        on(qs('#save-note-btn'), 'click', App.saveCurrentNote);
        on(qs('#theme-toggle-btn'), 'click', App.toggleTheme);

        // New Note Modal
        on(qs('#cancel-new-note'), 'click', App.closeNewNoteModal);
        on(qs('#create-new-note'), 'click', () => {
            const title = qs('#new-note-title').value.trim();
            App.createNote(title);
            App.closeNewNoteModal();
        });
        on(qs('#new-note-title'), 'keydown', (e) => {
            if (e.key === 'Enter') qs('#create-new-note').click();
        });

        // Search
        on(qs('#search-input'), 'input', e => {
            const q = e.target.value.toLowerCase();
            const filtered = App.state.notes.filter(note => note.title.toLowerCase().includes(q) || note.content.toLowerCase().includes(q));
            App.renderFileList(filtered);
        });

        // Editor and Preview
        App.editor.on('change', App.renderPreview);
        App.editor.on('blur', App.saveCurrentNote);

        // Toolbar buttons
        const toolbarActions = {
            'bold-btn': '**',
            'italic-btn': '*',
            'code-btn': '`'
        };
        Object.entries(toolbarActions).forEach(([id, wrap]) => {
            on(qs(`#${id}`), 'click', () => {
                const sel = App.editor.getSelection() || 'text';
                App.editor.replaceSelection(`${wrap}${sel}${wrap}`);
                App.editor.focus();
            });
        });
        on(qs('#heading-btn'), 'click', () => { App.editor.replaceSelection('\n## Heading\n'); App.editor.focus(); });
        on(qs('#list-btn'), 'click', () => { App.editor.replaceSelection('\n- List item\n'); App.editor.focus(); });
        on(qs('#link-btn'), 'click', () => {
            const sel = App.editor.getSelection() || 'link text';
            App.editor.replaceSelection(`[${sel}](https://)`);
            App.editor.focus();
        });

        // Resizer
        on(qs('#resize-handle'), 'mousedown', e => { App.isResizing = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
        on(document, 'mousemove', e => {
            if (!App.isResizing) return;
            const container = qs('.editor-container');
            const editorPane = qs('.editor-pane');
            const rect = container.getBoundingClientRect();
            const percentage = ((e.clientX - rect.left) / rect.width) * 100;
            if (percentage > 20 && percentage < 80) {
                editorPane.style.flex = `0 0 ${percentage}%`;
            }
        });
        on(document, 'mouseup', () => {
            if (!App.isResizing) return;
            App.isResizing = false;
            document.body.style.cursor = '';
            setTimeout(() => App.editor.refresh(), 50);
        });

        // Command Palette
        on(qs('#paletteInput'), 'input', (e) => App.filterPalette(e.target.value));
        on(qs('#paletteList'), 'click', e => {
            const item = e.target.closest('.palette-item');
            if (item) App.runPaletteItem(Number(item.dataset.index));
        });
        on(qs('#palette'), 'click', e => { if (e.target.id === 'palette') App.closePalette(); });

        // Global Keyboard Shortcuts
        on(document, 'keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); App.saveCurrentNote(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') { e.preventDefault(); App.openNewNoteModal(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); App.openPalette(); }
            if (e.key === 'Escape') { App.closePalette(); App.closeNewNoteModal(); }
        });
    };
    
    // ====== App Initialization ======
    (function init() {
        // 1. Configure libraries
        marked.setOptions({
            gfm: true, breaks: true, smartypants: true,
            renderer: new marked.Renderer(),
            highlight: (code, lang) => {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
        });

        // 2. Initialize CodeMirror editor
        App.editor = CodeMirror.fromTextArea(qs('#markdown-editor'), {
            mode: 'markdown', theme: 'monokai',
            lineNumbers: true, lineWrapping: true, autofocus: true,
        });

        // 3. Load data and set initial state
        App.loadState();
        App.setTheme(App.state.theme);
        App.renderFileList();
        
        if (App.state.notes.length > 0) {
            App.openNote(App.state.currentNoteId || App.state.notes[0].id);
        } else {
            App.createNote('Welcome to Markdown Studio', '# Welcome to Markdown Studio ✨\n\nThis is a fully self-contained markdown editor built as a "Micro-App".\n\n## Features\n\n- Real-time preview\n- Syntax highlighting (via highlight.js)\n- Dark & Light themes\n- Notes are saved in your browser\'s local storage\n\n**Press `Ctrl+K` to see available commands!**');
        }
        
        // 4. Wire up all events
        App.setupEventListeners();
        
        console.log("Markdown Studio Initialized");
    })();
</script>
</body>
</html>