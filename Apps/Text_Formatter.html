<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Text Formatter · URL Extractor & Cleaner</title>
	<style>
		:root{
			--bg:#0f1115; --panel:#151924; --panel-2:#0c0f16; --text:#e5e7eb; --muted:#a3aab8;
			--primary:#5b9cff; --primary-2:#2f6fe6; --border:#232836; --shadow:rgba(0,0,0,.4);
			--radius:14px; --radius-sm:10px; --pad:14px; --pad-sm:10px;
		}
		[data-theme="light"]{
			--bg:#f5f7fb; --panel:#ffffff; --panel-2:#f3f5fa; --text:#0f172a; --muted:#475569;
			--primary:#2563eb; --primary-2:#1e40af; --border:#e5e7eb; --shadow:rgba(0,0,0,.08);
		}
		*{box-sizing:border-box}
		html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
			font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial}
		.app{min-height:100%;display:grid;grid-template-rows:auto 1fr}
			header{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;
				padding:var(--pad);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0)), var(--bg);
				border-bottom:1px solid var(--border);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}
		.brand{display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);
			border-radius:var(--radius-sm);padding:8px 12px;box-shadow:0 6px 20px var(--shadow);font-weight:700}
		.spacer{flex:1}
		.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
			background:var(--panel);color:var(--muted);font-size:12px}
		main{padding:var(--pad);display:grid;grid-template-columns:1fr 1fr;gap:var(--pad)}
		@media (max-width: 980px){main{grid-template-columns:1fr}}
		.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
			box-shadow:0 12px 36px var(--shadow);padding:var(--pad);display:flex;flex-direction:column;gap:10px}
		h2{margin:0 0 6px}
		p.muted{color:var(--muted);margin:0}
		textarea{width:100%;min-height:320px;background:var(--panel-2);color:var(--text);
			border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;
			font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
		.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
		.btn{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);
			border-radius:var(--radius-sm);padding:10px 12px;cursor:pointer;transition:transform .12s, border-color .12s, background .12s}
		.btn:hover{transform:translateY(-1px);border-color:var(--primary)}
		.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
		.btn.primary:hover{background:var(--primary-2);border-color:var(--primary-2)}
		.stats{display:flex;gap:10px;flex-wrap:wrap}
		.chip{border:1px solid var(--border);background:var(--panel-2);color:var(--muted);
			border-radius:999px;padding:6px 10px;font-size:12px}
		.switch{display:inline-flex;align-items:center;gap:8px}
		.switch input{accent-color:var(--primary)}
		footer{padding:10px var(--pad);color:var(--muted)}
		.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;padding:2px 6px;border:1px solid var(--border);
			border-bottom-width:3px;border-radius:6px;background:var(--panel-2);color:var(--text);font-size:12px}
		.count{font-weight:700;color:var(--primary)}
	</style>
	<meta name="description" content="Extract and clean URLs from large text. Removes direct image links. One link per line, copy to clipboard." />
	<meta name="color-scheme" content="dark light" />
	<link rel="icon" href="data:," />
	<script>
		// Minimal preferences (theme only) in localStorage
		const STORE_KEY = 'textFormatter.prefs.v1';
		const Prefs = {
			load(){
				try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || { theme: 'dark', removeTracking: true }; }
				catch{ return { theme: 'dark', removeTracking: true }; }
			},
			save(v){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(v)); }catch{}
			}
		};

		// URL utilities
		const IMAGE_EXT_RE = /\.(?:apng|avif|gif|jpe?g|png|svg|webp|bmp|tiff?|heif|heic)(?:$|[?#])/i;
		const URL_RE = /https?:\/\/[^\s<>"]+/gi; // broad capture; further sanitize later

		function stripWrapping(url){
			// Remove common wrappers like <...> and trailing punctuation that isn't part of URL
			let s = url.trim();
			if (s.startsWith('<') && s.endsWith('>')) s = s.slice(1,-1);
			s = s.replace(/&amp;/g,'&');
			// Remove trailing punctuation often stuck to URLs
			// Keep balance for parentheses: avoid stripping ')' if there is no matching '('
			const trail = /[\)\]\}"'.,;:!?»]+$/;
			while (trail.test(s)) {
				const last = s.slice(-1);
				// If it's ')' but URL has fewer '(' than ')' already, break
				if (last === ')') {
					const opens = (s.match(/\(/g)||[]).length;
					const closes = (s.match(/\)/g)||[]).length;
					if (closes <= opens) break;
				}
				s = s.slice(0,-1);
			}
			return s;
		}

		function removeTrackingParams(u){
			// Remove common tracking parameters in-place on a URL object
			const sp = u.searchParams;
			const toDelete = new Set([
				'fbclid','gclid','dclid','msclkid','yclid','gbraid','wbraid','igshid','mc_cid','mc_eid','mkt_tok','_hsenc','_hsmi','vero_id','vero_conv','ref','ref_src','ref_url','irgwc'
			]);
			// delete all utm_* and pk_* (Matomo) as well
			[...sp.keys()].forEach(k=>{
				if (k.toLowerCase().startsWith('utm_') || k.toLowerCase().startsWith('pk_') || toDelete.has(k)) sp.delete(k);
			});
			return u;
		}

		function normalizeUrl(str, opts){
			try{
				const u = new URL(str);
				if (!(u.protocol === 'http:' || u.protocol === 'https:')) return null;
				if (opts.removeTracking) removeTrackingParams(u);
				// Keep as-is otherwise to avoid over-normalizing
				const qs = u.searchParams.toString();
				return u.origin + u.pathname + (qs ? ('?' + qs) : '') + (u.hash || '');
			}catch{ return null }
		}

		function isImageDirect(str){
			try{ const u = new URL(str); return IMAGE_EXT_RE.test(u.pathname); }
			catch{ return IMAGE_EXT_RE.test(str); }
		}

		function extractUrls(text, opts){
			const seen = new Set();
			const out = [];
			const images = [];
			const allMatches = text.match(URL_RE) || [];
			let total = 0;
			for (let raw of allMatches){
				total++;
				const cleaned = stripWrapping(raw);
				const norm = normalizeUrl(cleaned, opts);
				if (!norm) continue;
				if (isImageDirect(norm)) { images.push(norm); continue; }
				if (!seen.has(norm)) { seen.add(norm); out.push(norm); }
			}
			return { links: out, images, total }; // images are those filtered out as direct images
		}

		function copyText(text){
			if (!text) return Promise.resolve(false);
			if (navigator.clipboard && window.isSecureContext) {
				return navigator.clipboard.writeText(text).then(()=>true, ()=>false);
			}
			// Fallback
			const ta = document.createElement('textarea');
			ta.value = text; ta.style.position='fixed'; ta.style.inset='-9999px';
			document.body.appendChild(ta); ta.focus(); ta.select();
			let ok = false; try { ok = document.execCommand('copy'); } catch{}
			ta.remove(); return Promise.resolve(ok);
		}

		window.addEventListener('DOMContentLoaded', () => {
			const prefs = Prefs.load();
			const root = document.getElementById('app');
			root.setAttribute('data-theme', prefs.theme || 'dark');

			const input = document.getElementById('input');
			const output = document.getElementById('output');
			const btnFormat = document.getElementById('btnFormat');
			const btnCopy = document.getElementById('btnCopy');
			const btnClear = document.getElementById('btnClear');
			const btnSwap = document.getElementById('btnSwap');
			const removeTracking = document.getElementById('optTracking');
			const themeToggle = document.getElementById('themeToggle');
			const statTotal = document.getElementById('statTotal');
			const statImages = document.getElementById('statImages');
			const statFinal = document.getElementById('statFinal');

			removeTracking.checked = !!prefs.removeTracking;

			function run(){
				const { links, images, total } = extractUrls(input.value || '', { removeTracking: removeTracking.checked });
				output.value = links.join('\n');
				statTotal.textContent = String(total);
				statImages.textContent = String(images.length);
				statFinal.textContent = String(links.length);
			}

			btnFormat.addEventListener('click', run);
			input.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='enter'){ e.preventDefault(); run(); }});
			document.getElementById('btnSelectAll').addEventListener('click', ()=>{ output.focus(); output.select(); });
			btnCopy.addEventListener('click', async ()=>{
				const ok = await copyText(output.value);
				btnCopy.textContent = ok ? 'Copied!' : 'Copy failed';
				setTimeout(()=>{ btnCopy.textContent = 'Copy'; }, 1200);
			});
			btnClear.addEventListener('click', ()=>{ input.value=''; output.value=''; statTotal.textContent='0'; statImages.textContent='0'; statFinal.textContent='0'; input.focus(); });
			btnSwap.addEventListener('click', ()=>{ const t = input.value; input.value = output.value; output.value = t; run(); });

			removeTracking.addEventListener('change', ()=>{ prefs.removeTracking = removeTracking.checked; Prefs.save(prefs); });
			themeToggle.addEventListener('click', ()=>{
				const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
				root.setAttribute('data-theme', next); prefs.theme = next; Prefs.save(prefs);
			});

			// If content was pasted before load (rare), run once
			if (input.value) run();
		});
	</script>
	<style>
		/* Small icon via pure CSS */
		.dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 0 3px rgba(91,156,255,.15)}
	</style>
</head>
<body>
	<div class="app" id="app" data-theme="dark">
		<header>
			<div class="brand"><span class="dot" aria-hidden="true"></span> Text Formatter</div>
			<span class="pill">Paste text, extract links, remove direct image URLs</span>
			<div class="spacer"></div>
			<button id="themeToggle" class="btn" title="Toggle theme" aria-label="Toggle theme">Theme</button>
		</header>

		<main>
			<section class="card" aria-label="Input">
				<div>
					<h2 class="mt0">Input</h2>
					<p class="muted">Paste any text containing URLs. Press Ctrl/Cmd + Enter to format.</p>
				</div>
				<textarea id="input" placeholder="Paste text with URLs, descriptions, and images here..."></textarea>
				<div class="row">
					<button id="btnFormat" class="btn primary">Extract & Format</button>
					<button id="btnClear" class="btn" title="Clear input and output">Clear</button>
					<button id="btnSwap" class="btn" title="Swap input and output">Swap</button>
					<span class="spacer"></span>
					<label class="switch"><input type="checkbox" id="optTracking" /> Remove tracking params (utm_*, fbclid, etc.)</label>
				</div>
			</section>

			<section class="card" aria-label="Output">
				<div>
					<h2 class="mt0">Output</h2>
					<p class="muted">One URL per line. Image links are removed automatically.</p>
				</div>
				<textarea id="output" readonly placeholder="Your cleaned list of URLs will appear here..."></textarea>
				<div class="row">
					<div class="stats">
						<span class="chip">Found: <span class="count" id="statTotal">0</span></span>
						<span class="chip">Images removed: <span class="count" id="statImages">0</span></span>
						<span class="chip">Final: <span class="count" id="statFinal">0</span></span>
					</div>
					<span class="spacer"></span>
					<button id="btnSelectAll" class="btn" title="Select all">Select all</button>
					<button id="btnCopy" class="btn primary" title="Copy to clipboard">Copy</button>
				</div>
			</section>
		</main>

		<footer>
			Tip: Use <span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">Enter</span> to extract quickly.
		</footer>
	</div>
</body>
</html>
